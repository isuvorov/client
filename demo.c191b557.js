(function () {var E=this;let J=()=>({events:{},emit(e,...t){for(let s of this.events[e]||[])s(...t)},on(e,t){return(this.events[e]=this.events[e]||[]).push(t),()=>this.events[e]=this.events[e].filter(e=>e!==t)}});class jb{constructor(t,e,r){if(this.connected=!1,this.emitter=J(),e)this.WS=e;else{if("undefined"==typeof WebSocket)throw new Error("No WebSocket support");this.WS=WebSocket}this.url=t,this.opts=r}init(t){t.onerror=t=>{this.emitter.emit("error",t.error||new Error("WS Error"))},t.onclose=()=>{this.ws&&(this.connected=!1,this.emitter.emit("disconnect"))},t.onmessage=t=>{let e;try{e=JSON.parse(t.data)}catch(r){return void this.error(t.data)}this.emitter.emit("message",e)},this.ws=t}connect(){return this.emitter.emit("connecting"),this.init(new this.WS(this.url,void 0,this.opts)),new Promise(t=>{this.ws.onopen=()=>{this.connected=!0,this.emitter.emit("connect"),t()}})}disconnect(){this.ws&&(this.ws.onclose(),this.ws.close(),this.ws=void 0)}on(t,e){return this.emitter.on(t,e)}send(t){this.ws&&this.ws.readyState===this.ws.OPEN?this.ws.send(JSON.stringify(t)):this.emitter.emit("error",new Error("WS was closed"))}error(t){let e=new Error("Wrong message format");e.received=t,this.emitter.emit("error",e)}}async function kb(e,a){a||(a=[]);let t=await e;return a=t.entries.concat(a),t.next?kb(t.next(),a):a}var lb={},pa=Object.getOwnPropertySymbols,mb=Object.prototype.hasOwnProperty,nb=Object.prototype.propertyIsEnumerable;function ob(r){if(null==r)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(r)}function pb(){try{if(!Object.assign)return!1;var r=new String("abc");if(r[5]="de","5"===Object.getOwnPropertyNames(r)[0])return!1;for(var e={},t=0;t<10;t++)e["_"+String.fromCharCode(t)]=t;if("0123456789"!==Object.getOwnPropertyNames(e).map(function(r){return e[r]}).join(""))return!1;var n={};return"abcdefghijklmnopqrst".split("").forEach(function(r){n[r]=r}),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},n)).join("")}catch(o){return!1}}lb=pb()?Object.assign:function(r,e){for(var t,n,o=ob(r),a=1;a<arguments.length;a++){for(var $ in t=Object(arguments[a]))mb.call(t,$)&&(o[$]=t[$]);if(pa){n=pa(t);for(var s=0;s<n.length;s++)nb.call(t,n[s])&&(o[n[s]]=t[n[s]])}}return o};var qb={};qb=function(t){return t&&"object"==typeof t&&"function"==typeof t.copy&&"function"==typeof t.fill&&"function"==typeof t.readUInt8};var qa={};qa="function"==typeof Object.create?function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:function(t,e){t.super_=e;var o=function(){};o.prototype=e.prototype,t.prototype=new o,t.prototype.constructor=t};var A,B,K={},g=K={};function Z(){throw new Error("setTimeout has not been defined")}function _(){throw new Error("clearTimeout has not been defined")}function ra(r){if(A===setTimeout)return setTimeout(r,0);if((A===Z||!A)&&setTimeout)return A=setTimeout,setTimeout(r,0);try{return A(r,0)}catch($){try{return A.call(null,r,0)}catch($){return A.call(this,r,0)}}}function rb(r){if(B===clearTimeout)return clearTimeout(r);if((B===_||!B)&&clearTimeout)return B=clearTimeout,clearTimeout(r);try{return B(r)}catch($){try{return B.call(null,r)}catch($){return B.call(this,r)}}}!function(){try{A="function"==typeof setTimeout?setTimeout:Z}catch(r){A=Z}try{B="function"==typeof clearTimeout?clearTimeout:_}catch(r){B=_}}();var F,y=[],aa=!1,sa=-1;function sb(){aa&&F&&(aa=!1,F.length?y=F.concat(y):sa=-1,y.length&&ta())}function ta(){if(!aa){var r=ra(sb);aa=!0;for(var $=y.length;$;){for(F=y,y=[];++sa<$;)F&&F[sa].run();sa=-1,$=y.length}F=null,aa=!1,rb(r)}}function ua(r,$){this.fun=r,this.array=$}function q(){}g.nextTick=function(r){var $=new Array(arguments.length-1);if(arguments.length>1)for(var e=1;e<arguments.length;e++)$[e-1]=arguments[e];y.push(new ua(r,$)),1!==y.length||aa||ra(ta)},ua.prototype.run=function(){this.fun.apply(null,this.array)},g.title="browser",g.env={},g.argv=[],g.version="",g.versions={},g.on=q,g.addListener=q,g.once=q,g.off=q,g.removeListener=q,g.removeAllListeners=q,g.emit=q,g.prependListener=q,g.prependOnceListener=q,g.listeners=function(r){return[]},g.binding=function(r){throw new Error("process.binding is not supported")},g.cwd=function(){return"/"},g.chdir=function(r){throw new Error("process.chdir is not supported")},g.umask=function(){return 0};var f={},tb=/%[sdj%]/g,ba=function(r){if(!P(r)){for(var $=[],e=0;e<arguments.length;e++)$.push(w(arguments[e]));return $.join(" ")}e=1;for(var t=arguments,n=t.length,i=String(r).replace(tb,function(r){if("%%"===r)return"%";if(e>=n)return r;switch(r){case"%s":return String(t[e++]);case"%d":return Number(t[e++]);case"%j":try{return JSON.stringify(t[e++])}catch($){return"[Circular]"}default:return r;}}),o=t[e];e<n;o=t[++e])N(o)||!C(o)?i+=" "+o:i+=" "+w(o);return i};f.format=ba;var va=function(r,$){if(v(E.process))return function(){return va(r,$).apply(this,arguments)};if(!0===K.noDeprecation)return r;var e=!1;return function(){if(!e){if(K.throwDeprecation)throw new Error($);K.traceDeprecation?console.trace($):console.error($),e=!0}return r.apply(this,arguments)}};f.deprecate=va;var wa,L={},ub=function(r){if(v(wa)&&(wa=""),r=r.toUpperCase(),!L[r])if(new RegExp("\\b"+r+"\\b","i").test(wa)){var $=K.pid;L[r]=function(){var e=ba.apply(f,arguments);console.error("%s %d: %s",r,$,e)}}else L[r]=function(){};return L[r]};function w(r,$){var e={seen:[],stylize:wb};return arguments.length>=3&&(e.depth=arguments[2]),arguments.length>=4&&(e.colors=arguments[3]),fa($)?e.showHidden=$:$&&Aa(e,$),v(e.showHidden)&&(e.showHidden=!1),v(e.depth)&&(e.depth=2),v(e.colors)&&(e.colors=!1),v(e.customInspect)&&(e.customInspect=!0),e.colors&&(e.stylize=vb),M(e,r,e.depth)}f.debuglog=ub;var ca=w;function vb(r,$){var e=w.styles[$];return e?"\x1B["+w.colors[e][0]+"m"+r+"\x1B["+w.colors[e][1]+"m":r}function wb(r,$){return r}function xb(r){var $={};return r.forEach(function(r,e){$[r]=!0}),$}function M(r,$,e){if(r.customInspect&&$&&T($.inspect)&&$.inspect!==ca&&(!$.constructor||$.constructor.prototype!==$)){var t=$.inspect(e,r);return P(t)||(t=M(r,t,e)),t}var n=yb(r,$);if(n)return n;var i=Object.keys($),o=xb(i);if(r.showHidden&&(i=Object.getOwnPropertyNames($)),S($)&&(i.indexOf("message")>=0||i.indexOf("description")>=0))return da($);if(0===i.length){if(T($)){var a=$.name?": "+$.name:"";return r.stylize("[Function"+a+"]","special")}if(Q($))return r.stylize(RegExp.prototype.toString.call($),"regexp");if(ha($))return r.stylize(Date.prototype.toString.call($),"date");if(S($))return da($)}var s,O="",p=!1,R=["{","}"];(xa($)&&(p=!0,R=["[","]"]),T($))&&(O=" [Function"+($.name?": "+$.name:"")+"]");return Q($)&&(O=" "+RegExp.prototype.toString.call($)),ha($)&&(O=" "+Date.prototype.toUTCString.call($)),S($)&&(O=" "+da($)),0!==i.length||p&&0!=$.length?e<0?Q($)?r.stylize(RegExp.prototype.toString.call($),"regexp"):r.stylize("[Object]","special"):(r.seen.push($),s=p?zb(r,$,e,o,i):i.map(function(t){return ea(r,$,e,o,t,p)}),r.seen.pop(),Ab(s,O,R)):R[0]+O+R[1]}function yb(r,$){if(v($))return r.stylize("undefined","undefined");if(P($)){var e="'"+JSON.stringify($).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,"\"")+"'";return r.stylize(e,"string")}return ya($)?r.stylize(""+$,"number"):fa($)?r.stylize(""+$,"boolean"):N($)?r.stylize("null","null"):void 0}function da(r){return"["+Error.prototype.toString.call(r)+"]"}function zb(r,$,e,t,n){for(var i=[],o=0,a=$.length;o<a;++o)Ba($,String(o))?i.push(ea(r,$,e,t,String(o),!0)):i.push("");return n.forEach(function(n){n.match(/^\d+$/)||i.push(ea(r,$,e,t,n,!0))}),i}function ea(r,$,e,t,n,i){var o,a,s;if((s=Object.getOwnPropertyDescriptor($,n)||{value:$[n]}).get?a=s.set?r.stylize("[Getter/Setter]","special"):r.stylize("[Getter]","special"):s.set&&(a=r.stylize("[Setter]","special")),Ba(t,n)||(o="["+n+"]"),a||(r.seen.indexOf(s.value)<0?(a=N(e)?M(r,s.value,null):M(r,s.value,e-1)).indexOf("\n")>-1&&(a=i?a.split("\n").map(function(r){return"  "+r}).join("\n").substr(2):"\n"+a.split("\n").map(function(r){return"   "+r}).join("\n")):a=r.stylize("[Circular]","special")),v(o)){if(i&&n.match(/^\d+$/))return a;(o=JSON.stringify(""+n)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=r.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,"\"").replace(/(^"|"$)/g,"'"),o=r.stylize(o,"string"))}return o+": "+a}function Ab(r,$,e){return r.reduce(function(r,$){return 0,$.indexOf("\n")>=0&&0,r+$.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60?e[0]+(""===$?"":$+"\n ")+" "+r.join(",\n  ")+" "+e[1]:e[0]+$+" "+r.join(", ")+" "+e[1]}function xa(r){return Array.isArray(r)}f.inspect=ca,w.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},w.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};var Bb=xa;function fa(r){return"boolean"==typeof r}f.isArray=Bb;var Cb=fa;function N(r){return null===r}f.isBoolean=Cb;var Db=N;function Eb(r){return null==r}f.isNull=Db;var Fb=Eb;function ya(r){return"number"==typeof r}f.isNullOrUndefined=Fb;var Gb=ya;function P(r){return"string"==typeof r}f.isNumber=Gb;var Hb=P;function Ib(r){return"symbol"==typeof r}f.isString=Hb;var Jb=Ib;function v(r){return void 0===r}f.isSymbol=Jb;var Kb=v;function Q(r){return C(r)&&"[object RegExp]"===la(r)}f.isUndefined=Kb;var ga=Q;function C(r){return"object"==typeof r&&null!==r}f.isRegExp=ga;var Lb=C;function ha(r){return C(r)&&"[object Date]"===la(r)}f.isObject=Lb;var ia=ha;function S(r){return C(r)&&("[object Error]"===la(r)||r instanceof Error)}f.isDate=ia;var za=S;function T(r){return"function"==typeof r}f.isError=za;var ja=T;function Mb(r){return null===r||"boolean"==typeof r||"number"==typeof r||"string"==typeof r||"symbol"==typeof r||void 0===r}f.isFunction=ja;var ka=Mb;f.isPrimitive=ka;function la(r){return Object.prototype.toString.call(r)}function ma(r){return r<10?"0"+r.toString(10):r.toString(10)}f.isBuffer=qb;var Nb=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function Ob(){var r=new Date,$=[ma(r.getHours()),ma(r.getMinutes()),ma(r.getSeconds())].join(":");return[r.getDate(),Nb[r.getMonth()],$].join(" ")}var Pb=function(){console.log("%s - %s",Ob(),ba.apply(f,arguments))};f.log=Pb;f.inherits=qa;var Aa=function(r,$){if(!$||!C($))return r;for(var e=Object.keys($),t=e.length;t--;)r[e[t]]=$[e[t]];return r};function Ba(r,$){return Object.prototype.hasOwnProperty.call(r,$)}f._extend=Aa;function Ca(r,$){if(r===$)return 0;for(var t=r.length,e=$.length,a=0,i=Math.min(t,e);a<i;++a)if(r[a]!==$[a]){t=r[a],e=$[a];break}return t<e?-1:e<t?1:0}function G(r){return E.Buffer&&"function"==typeof E.Buffer.isBuffer?E.Buffer.isBuffer(r):!(null==r||!r._isBuffer)}var Qb=Object.prototype.hasOwnProperty,Da=Array.prototype.slice,Ea="foo"===function(){}.name;function Fa(r){return Object.prototype.toString.call(r)}function Ga(r){return!G(r)&&"function"==typeof E.ArrayBuffer&&("function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(r):!!r&&(r instanceof DataView||!!(r.buffer&&r.buffer instanceof ArrayBuffer)))}var b=Ka,Rb=/\s*function\s+([^\(\s]*)\s*/;function Ha(r){if(ja(r)){if(Ea)return r.name;var $=r.toString().match(Rb);return $&&$[1]}}function Ia(r,$){return"string"==typeof r?r.length<$?r:r.slice(0,$):r}function Ja(r){if(Ea||!ja(r))return ca(r);var $=Ha(r);return"[Function"+($?": "+$:"")+"]"}function Sb(r){return Ia(Ja(r.actual),128)+" "+r.operator+" "+Ia(Ja(r.expected),128)}function j(r,$,t,e,a){throw new b.AssertionError({message:t,actual:r,expected:$,operator:e,stackStartFunction:a})}function Ka(r,$){r||j(r,!0,$,"==",b.ok)}function D(r,$,t,e){if(r===$)return!0;if(G(r)&&G($))return 0===Ca(r,$);if(ia(r)&&ia($))return r.getTime()===$.getTime();if(ga(r)&&ga($))return r.source===$.source&&r.global===$.global&&r.multiline===$.multiline&&r.lastIndex===$.lastIndex&&r.ignoreCase===$.ignoreCase;if(null!==r&&"object"==typeof r||null!==$&&"object"==typeof $){if(Ga(r)&&Ga($)&&Fa(r)===Fa($)&&!(r instanceof Float32Array||r instanceof Float64Array))return 0===Ca(new Uint8Array(r.buffer),new Uint8Array($.buffer));if(G(r)!==G($))return!1;var a=(e=e||{actual:[],expected:[]}).actual.indexOf(r);return-1!==a&&a===e.expected.indexOf($)||(e.actual.push(r),e.expected.push($),Tb(r,$,t,e))}return t?r===$:r==$}function La(r){return"[object Arguments]"==Object.prototype.toString.call(r)}function Tb(r,$,t,e){if(null==r||null==$)return!1;if(ka(r)||ka($))return r===$;if(t&&Object.getPrototypeOf(r)!==Object.getPrototypeOf($))return!1;var a=La(r),i=La($);if(a&&!i||!a&&i)return!1;if(a)return D(r=Da.call(r),$=Da.call($),t);var n,p,s=Qa(r),u=Qa($);if(s.length!==u.length)return!1;for(s.sort(),u.sort(),p=s.length-1;p>=0;p--)if(s[p]!==u[p])return!1;for(p=s.length-1;p>=0;p--)if(!D(r[n=s[p]],$[n],t,e))return!1;return!0}function Ma(r,$,t){D(r,$,!0)&&j(r,$,t,"notDeepStrictEqual",Ma)}function Na(r,$){if(!r||!$)return!1;if("[object RegExp]"==Object.prototype.toString.call($))return $.test(r);try{if(r instanceof $)return!0}catch(t){}return!Error.isPrototypeOf($)&&!0===$.call({},r)}function Ub(r){var $;try{r()}catch(t){$=t}return $}function Oa(r,$,t,e){var a;if("function"!=typeof $)throw new TypeError("\"block\" argument must be a function");"string"==typeof t&&(e=t,t=null),a=Ub($),e=(t&&t.name?" ("+t.name+").":".")+(e?" "+e:"."),r&&!a&&j(a,t,"Missing expected exception"+e);var i="string"==typeof e,n=!r&&a&&!t;if((!r&&za(a)&&i&&Na(a,t)||n)&&j(a,t,"Got unwanted exception"+e),r&&a&&t&&!Na(a,t)||!r&&a)throw a}function Pa(r,$){r||j(r,!0,$,"==",Pa)}b.AssertionError=function(r){this.name="AssertionError",this.actual=r.actual,this.expected=r.expected,this.operator=r.operator,r.message?(this.message=r.message,this.generatedMessage=!1):(this.message=Sb(this),this.generatedMessage=!0);var $=r.stackStartFunction||j;if(Error.captureStackTrace)Error.captureStackTrace(this,$);else{var t=new Error;if(t.stack){var e=t.stack,a=Ha($),i=e.indexOf("\n"+a);if(i>=0){var n=e.indexOf("\n",i+1);e=e.substring(n+1)}this.stack=e}}},qa(b.AssertionError,Error),b.fail=j,b.ok=Ka,b.equal=function(r,$,t){r!=$&&j(r,$,t,"==",b.equal)},b.notEqual=function(r,$,t){r==$&&j(r,$,t,"!=",b.notEqual)},b.deepEqual=function(r,$,t){D(r,$,!1)||j(r,$,t,"deepEqual",b.deepEqual)},b.deepStrictEqual=function(r,$,t){D(r,$,!0)||j(r,$,t,"deepStrictEqual",b.deepStrictEqual)},b.notDeepEqual=function(r,$,t){D(r,$,!1)&&j(r,$,t,"notDeepEqual",b.notDeepEqual)},b.notDeepStrictEqual=Ma,b.strictEqual=function(r,$,t){r!==$&&j(r,$,t,"===",b.strictEqual)},b.notStrictEqual=function(r,$,t){r===$&&j(r,$,t,"!==",b.notStrictEqual)},b.throws=function(r,$,t){Oa(!0,r,$,t)},b.doesNotThrow=function(r,$,t){Oa(!1,r,$,t)},b.ifError=function(r){if(r)throw r},b.strict=lb(Pa,b,{equal:b.strictEqual,deepEqual:b.deepStrictEqual,notEqual:b.notStrictEqual,notDeepEqual:b.notDeepStrictEqual}),b.strict.strict=b.strict;var Qa=Object.keys||function(r){var $=[];for(var t in r)Qb.call(r,t)&&$.push(t);return $};function Ra(i){let r=i.indexOf(" ");return[i.slice(0,r),i.slice(r+1)]}function H(i,r){if(i&&!r)return!1;if(!i&&r)return!0;if(i.time>r.time)return!1;if(i.time<r.time)return!0;let t=Ra(i.id),e=Ra(r.id);return!(t[1]>e[1])&&(t[1]<e[1]||!(t[0]>e[0])&&t[0]<e[0])}function Sa(e,t){return e.lastAdded+=1,t[1].added=e.lastAdded,e.added.push(t),Promise.resolve(t[1])}function U(e,t){for(let d=e.length-1;d>=0;d--)if(t===e[d][1].id)return d;return-1}function V(e){return void 0!==e}class Ta{constructor(){this.created=[],this.added=[],this.lastReceived=0,this.lastAdded=0,this.lastSent=0}async add(e,t){let d=[e,t],i=t.id,r=this.created;for(let s=0;s<r.length;s++){let[,e]=r[s];if(i===e.id)return!1;if(!H(e,t))return r.splice(s,0,d),Sa(this,d)}return r.push(d),Sa(this,d)}async byId(e){let t=U(this.created,e);if(-1===t)return[null,null];{let[e,d]=this.created[t];return[e,d]}}async remove(e,t){if(void 0===t&&-1===(t=U(this.created,e)))return Promise.resolve(!1);let d=[this.created[t][0],this.created[t][1]];this.created.splice(t,1);let i=d[1].added,r=0,s=this.added.length-1;for(;r<=s;){let e=s+r>>1,t=this.added[e][1].added;if(t<i)r=e+1;else{if(!(t>i)){this.added.splice(e,1);break}s=e-1}}return d}async get(e){let t;return{entries:(t="created"===e.order?this.created:this.added).slice(0)}}async changeMeta(e,t){let d=U(this.created,e);if(-1===d)return!1;{let e=this.created[d][1];for(let d in t)e[d]=t[d];return!0}}async removeReason(e,t,d){let i=[];if(t.id){let i=U(this.created,t.id);if(-1!==i){let r=this.created[i][1],s=r.reasons.indexOf(e);-1!==s&&(r.reasons.splice(s,1),0===r.reasons.length&&(d(this.created[i][0],r),this.remove(t.id)))}}else this.created=this.created.filter(([r,s])=>{let a=t,n=s.reasons.indexOf(e);return-1===n||!(!V(a.olderThan)||H(s,a.olderThan))||!(!V(a.youngerThan)||H(a.youngerThan,s))||!!(V(a.minAdded)&&s.added<a.minAdded)||!!(V(a.maxAdded)&&s.added>a.maxAdded)||(s.reasons.splice(n,1),0!==s.reasons.length||(d(r,s),i.push(s.added),!1))}),this.added=this.added.filter(e=>!i.includes(e[1].added))}async clean(){this.created=[],this.added=[],this.lastReceived=0,this.lastAdded=0,this.lastSent=0}async getLastAdded(){return this.lastAdded}async getLastSynced(){return{received:this.lastReceived,sent:this.lastSent}}async setLastSynced(e){void 0!==e.sent&&(this.lastSent=e.sent),void 0!==e.received&&(this.lastReceived=e.received)}}async function Ua(t,o,e,n){if(!t.options.auth)return t.authenticated=!0,void n();try{if(await t.options.auth(o,e)){t.authenticated=!0,n();for(let o=0;o<t.unauthenticated.length;o++)t.onMessage(t.unauthenticated[o]);t.unauthenticated=[]}else t.sendError(new z("wrong-credentials")),t.destroy()}catch(s){"LoguxError"===s.name?(t.sendError(s),t.destroy()):t.error(s)}}function Va(t,o){return t.remoteProtocol=o,o>=t.minProtocol||(t.sendError(new z("wrong-protocol",{supported:t.minProtocol,used:o})),t.destroy(),!1)}function Wa(t){try{t.emitter.emit("connect")}catch(o){if("LoguxError"===o.name)return t.sendError(o),!1;throw o}return!0}async function Vb(){let t=["connect",this.localProtocol,this.localNodeId,this.lastReceived],o={};this.options.token&&("function"==typeof this.options.token?o.token=await this.options.token():o.token=this.options.token),this.options.subprotocol&&(o.subprotocol=this.options.subprotocol),Object.keys(o).length>0&&t.push(o),this.options.fixTime&&(this.connectSended=this.now()),this.startTimeout(),this.send(t)}async function Wb(t,o){let e=["connected",this.localProtocol,this.localNodeId,[t,o]],n={};this.options.token&&("function"==typeof this.options.token?n.token=await this.options.token():n.token=this.options.token),this.options.subprotocol&&(n.subprotocol=this.options.subprotocol),Object.keys(n).length>0&&e.push(n),this.send(e)}function Xb(t,o,e,n){let s=this.now();n||(n={}),this.remoteNodeId=o,Va(this,t)&&(this.remoteSubprotocol=n.subprotocol||"0.0.0",Wa(this)?Ua(this,o,n.token,()=>{this.baseTime=this.now(),this.sendConnected(s,this.baseTime),this.syncSince(e)}):this.destroy())}function Yb(t,o,e,n){if(n||(n={}),this.endTimeout(),this.remoteNodeId=o,Va(this,t)){if(this.baseTime=e[1],this.options.fixTime){let t=this.now(),o=e[1]-e[0],n=t-this.connectSended-o;this.timeFix=Math.floor(this.connectSended-e[0]+n/2)}this.remoteSubprotocol=n.subprotocol||"0.0.0",Wa(this)?Ua(this,o,n.token,()=>{this.syncSince(this.lastSent)}):this.destroy()}}class z extends Error{static describe(r,o){return"timeout"===r?"A timeout was reached ("+o+"ms)":"wrong-format"===r?"Wrong message format in "+o:"unknown-message"===r?"Unknown message `"+o+"` type":"bruteforce"===r?"Too many wrong authentication attempts":"wrong-protocol"===r?"Logux supports protocols only from version "+o.supported+", but you use "+o.used:"wrong-subprotocol"===r?"Only "+o.supported+" application subprotocols are supported, but you use "+o.used:"wrong-credentials"===r?"Wrong credentials":r}constructor(r,o,e){super(r),this.name="LoguxError",this.type=r,this.options=o,this.description=z.describe(r,o),this.received=!!e,e?(this.message="Logux received "+this.type+" error",this.description!==this.type&&(this.message+=" ("+this.description+")")):this.message=this.description,Error.captureStackTrace&&Error.captureStackTrace(this,z)}}function Zb(e,i){this.startTimeout();let t=[];for(let[s,n]of i){let e={};for(let i in n)"id"===i?e.id=n.id.split(" "):"added"!==i&&(e[i]=n[i]);this.timeFix&&(e.time-=this.timeFix),e.id[0]=parseInt(e.id[0])-this.baseTime,e.id[2]=parseInt(e.id[2]),e.time-=this.baseTime,e.id[1]===this.localNodeId&&(0===e.id[2]?e.id=e.id[0]:e.id=[e.id[0],e.id[2]]),t.unshift(s,e)}this.syncing+=1,this.setState("sending"),this.send(["sync",e].concat(t))}function $b(e){this.send(["synced",e])}async function _b(e,...i){let t=[];for(let s=0;s<i.length-1;s+=2){let e=i[s],n=i[s+1];"number"==typeof n.id?n.id=n.id+this.baseTime+" "+this.remoteNodeId+" 0":(n.id[0]=n.id[0]+this.baseTime,2===n.id.length?n.id=n.id[0]+" "+this.remoteNodeId+" "+n.id[1]:n.id=n.id.join(" ")),n.time=n.time+this.baseTime,this.timeFix&&(n.time=n.time+this.timeFix);let d=Promise.resolve([e,n]);this.options.inMap&&(d=d.then(([e,i])=>this.options.inMap(e,i)).catch(e=>{this.error(e)})),d.then(e=>e&&this.options.inFilter?this.options.inFilter(...e).then(i=>!!i&&e).catch(e=>{this.error(e)}):e).then(e=>!!e&&(this.received&&(this.received[e[1].id]=!0),this.log.add(e[0],e[1]))),t.push(d)}await Promise.all(t),this.setLastReceived(e),this.sendSynced(e)}function ac(e){this.endTimeout(),this.setLastSent(e),this.syncing>0&&(this.syncing-=1),0===this.syncing&&this.setState("synchronized")}function bc(){this.startTimeout(),this.send(["ping",this.lastAddedCache]),this.pingTimeout&&clearTimeout(this.pingTimeout)}function cc(e){this.setLastReceived(e),this.connected&&this.authenticated&&this.send(["pong",this.lastAddedCache])}function dc(e){this.setLastReceived(e),this.endTimeout()}function ec(e,$){this.send(["debug",e,$])}function fc(e,$){this.emitter.emit("debug",e,$)}function gc(r){let e=["error",r.type];void 0!==r.options&&e.push(r.options),this.send(e),this.emitter.emit("clientError",r)}function hc(r,e){this.syncError(r,e,!0)}const ic={"wrong-subprotocol":!0,"wrong-protocol":!0,timeout:!0},jc=["connect","connected","error","debug"];async function Xa(e,t,o){let s=o.added;if(void 0===s){let t=e.lastAddedCache;s=t>e.lastSent?t:e.lastSent}if(e.options.outMap)try{let n=await e.options.outMap(t,o);e.sendSync(s,[n])}catch(i){e.error(i)}else e.sendSync(s,[[t,o]])}class h{constructor(e,t,o,s={}){if(this.remoteNodeId=void 0,this.remoteProtocol=void 0,this.remoteSubprotocol=void 0,this.minProtocol=3,this.localProtocol=3,this.localNodeId=e,this.log=t,this.connection=o,this.options=s,this.options.ping&&!this.options.timeout)throw new Error("You must set timeout option to use ping");this.connected=!1,this.authenticated=!1,this.unauthenticated=[],this.timeFix=0,this.syncing=0,this.received={},this.lastSent=0,this.lastReceived=0,this.state="disconnected",this.emitter=J(),this.timeouts=[],this.throwsError=!0,this.unbind=[],this.unbind.push(t.on("add",(e,t)=>{this.onAdd(e,t)})),this.unbind.push(o.on("connecting",()=>{this.onConnecting()})),this.unbind.push(o.on("connect",()=>{this.onConnect()})),this.unbind.push(o.on("message",e=>{this.onMessage(e)})),this.unbind.push(o.on("error",e=>{"Wrong message format"===e.message?(this.sendError(new z("wrong-format",e.received)),this.connection.disconnect("error")):this.error(e)})),this.unbind.push(o.on("disconnect",()=>{this.onDisconnect()})),this.initialized=!1,this.lastAddedCache=0,this.initializing=this.initialize()}on(e,t){return this.emitter.on(e,t)}catch(e){this.throwsError=!1,this.on("error",e)}waitFor(e){return this.state===e?Promise.resolve():new Promise(t=>{let o=this.on("state",()=>{this.state===e&&(o(),t())})})}destroy(){this.connection.destroy?this.connection.destroy():this.connected&&this.connection.disconnect("destroy");for(let e of this.unbind)e();clearTimeout(this.pingTimeout),this.endTimeout()}send(e){if(this.connected){this.delayPing();try{this.connection.send(e)}catch(t){this.error(t)}}}onConnecting(){this.setState("connecting")}onConnect(){this.delayPing(),this.connected=!0}onDisconnect(){for(;this.timeouts.length>0;)this.endTimeout();this.pingTimeout&&clearTimeout(this.pingTimeout),this.authenticated=!1,this.connected=!1,this.setState("disconnected")}onMessage(e){this.delayPing();let t=e[0];this.authenticated||jc.includes(t)?this[t+"Message"](...e.slice(1)):this.unauthenticated.push(e)}async onAdd(e,t){if(this.authenticated)if(this.lastAddedCache<t.added&&(this.lastAddedCache=t.added),this.received&&this.received[t.id])delete this.received[t.id];else if(this.options.outFilter)try{(await this.options.outFilter(e,t))&&Xa(this,e,t)}catch(o){this.error(o)}else Xa(this,e,t)}syncError(e,t,o){let s=new z(e,t,o);if(this.emitter.emit("error",s),!ic[e]&&this.throwsError)throw s}error(e){if(this.emitter.emit("error",e),this.connection.disconnect("error"),this.throwsError)throw e}setState(e){this.state!==e&&(this.state=e,this.emitter.emit("state"))}startTimeout(){if(!this.options.timeout)return;let e=this.options.timeout,t=setTimeout(()=>{this.connected&&this.connection.disconnect("timeout"),this.syncError("timeout",e)},e);this.timeouts.push(t)}endTimeout(){this.timeouts.length>0&&clearTimeout(this.timeouts.shift())}delayPing(){this.options.ping&&(this.pingTimeout&&clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{this.connected&&this.authenticated&&this.sendPing()},this.options.ping))}async syncSinceQuery(e){let t=[];await this.log.each({order:"added"},(o,s)=>!(s.added<=e)&&(this.options.outFilter?t.push(this.options.outFilter(o,s).then(e=>!!e&&[o,s]).catch(e=>{this.error(e)})):t.push(Promise.resolve([o,s])),!0));let o=await Promise.all(t),s={added:0};return s.entries=o.filter(e=>(e&&s.added<e[1].added&&(s.added=e[1].added),!1!==e)),s}async syncSince(e){let t=await this.syncSinceQuery(e);this.connected&&(t.entries.length>0?this.options.outMap?Promise.all(t.entries.map(e=>this.options.outMap(e[0],e[1]))).then(e=>{this.sendSync(t.added,e)}).catch(e=>{this.error(e)}):this.sendSync(t.added,t.entries):this.setState("synchronized"))}setLastSent(e){this.lastSent<e&&(this.lastSent=e,this.log.store.setLastSynced({sent:e}))}setLastReceived(e){this.lastReceived<e&&(this.lastReceived=e),this.log.store.setLastSynced({received:e})}now(){return Date.now()}async initialize(){let[e,t]=await Promise.all([this.log.store.getLastSynced(),this.log.store.getLastAdded()]);this.initialized=!0,this.lastSent=e.sent,this.lastReceived=e.received,this.lastAddedCache=t,this.connection.connected&&this.onConnect()}sendDuilian(){this.send(["duilian",Object.keys(na)[0]])}duilianMessage(e){na[e]&&this.send(["duilian",na[e]])}}h.prototype.sendConnect=Vb,h.prototype.sendConnected=Wb,h.prototype.connectMessage=Xb,h.prototype.connectedMessage=Yb,h.prototype.sendSync=Zb,h.prototype.sendSynced=$b,h.prototype.syncMessage=_b,h.prototype.syncedMessage=ac,h.prototype.sendPing=bc,h.prototype.pingMessage=cc,h.prototype.pongMessage=dc,h.prototype.sendDebug=ec,h.prototype.debugMessage=fc,h.prototype.sendError=gc,h.prototype.errorMessage=hc;const na={"\u91D1\u6728\u6C34\u706B\u571F":"\u677F\u57CE\u70E7\u9505\u9152"};const kc={fixTime:!0,timeout:2e4,ping:5e3};class Ya extends h{constructor(e,t,i,n={}){super(e,t,i,n={...kc,...n})}onConnect(){this.connected||(this.connected=!0,this.initializing=this.initializing.then(()=>{this.connected&&this.sendConnect()}))}}function k(r){return"number"==typeof r}function x(r){return"string"==typeof r}function W(r){return"object"==typeof r&&"number"!=typeof r.length}function Za(r){return Array.isArray(r)}function $a(r){return Za(r)&&2===r.length&&k(r[0])&&k(r[1])}function lc(r){return Za(r)&&3===r.length&&k(r[0])&&x(r[1])&&k(r[2])}function mc(r){return W(r)&&k(r.time)&&(k(r.id)||$a(r.id)||lc(r.id))}let a={connect:r=>k(r[1])&&x(r[2])&&k(r[3])&&(4===r.length||5===r.length&&W(r[4])),connected:r=>k(r[1])&&x(r[2])&&$a(r[3])&&(4===r.length||5===r.length&&W(r[4])),ping:r=>2===r.length&&k(r[1]),pong:r=>2===r.length&&k(r[1]),sync(r){if(!k(r[1]))return!1;if(r.length%2!=0)return!1;for(let $=2;$<r.length;$++)if($%2==0){if(!W(r[$])||!x(r[$].type))return!1}else if(!mc(r[$]))return!1;return!0},synced:r=>2===r.length&&k(r[1]),error:r=>(2===r.length||3===r.length)&&x(r[1]),duilian:r=>2===r.length&&x(r[1]),debug:r=>3===r.length&&x(r[1])&&"error"===r[1]&&x(r[2])};const nc={minDelay:1e3,maxDelay:5e3,attempts:1/0},oc=["wrong-protocol","wrong-subprotocol","wrong-credentials"];class pc{constructor(n,t={}){this.connection=n,this.options={...nc,...t},this.reconnecting=n.connected,this.connecting=!1,this.attempts=0,this.unbind=[],this.unbind.push(this.connection.on("message",n=>{"error"===n[0]&&oc.includes(n[1])&&(this.reconnecting=!1)})),this.unbind.push(this.connection.on("connecting",()=>{this.connecting=!0})),this.unbind.push(this.connection.on("connect",()=>{this.attempts=0,this.connecting=!1})),this.unbind.push(this.connection.on("disconnect",()=>{this.connecting=!1,this.reconnecting&&this.reconnect()})),this.unbind.push(()=>{clearTimeout(this.timer)});let e=()=>{!this.reconnecting||this.connected||this.connecting||"undefined"==typeof document||document.hidden||this.connect()},i=()=>{!this.reconnecting||this.connected||this.connecting||navigator.onLine&&this.connect()},o=()=>{this.disconnect("freeze")};"undefined"!=typeof document&&"undefined"!=typeof window&&document.addEventListener&&window.addEventListener&&(document.addEventListener("visibilitychange",e,!1),window.addEventListener("focus",i,!1),window.addEventListener("online",i,!1),window.addEventListener("resume",i,!1),window.addEventListener("freeze",o,!1),this.unbind.push(()=>{document.removeEventListener("visibilitychange",e,!1),window.removeEventListener("focus",i,!1),window.removeEventListener("online",i,!1),window.removeEventListener("resume",i,!1),window.removeEventListener("freeze",o,!1)}))}connect(){return this.attempts+=1,this.reconnecting=!0,this.connection.connect()}disconnect(n){return"timeout"!==n&&"error"!==n&&"freeze"!==n&&(this.reconnecting=!1),this.connection.disconnect(n)}destroy(){for(let n of this.unbind)n();this.disconnect("destroy")}reconnect(){if(this.attempts>this.options.attempts-1)return this.reconnecting=!1,void(this.attempts=0);let n=this.nextDelay();this.timer=setTimeout(()=>{!this.reconnecting||this.connecting||this.connected||this.connect()},n)}send(...n){return this.connection.send(...n)}on(...n){return this.connection.on(...n)}nextDelay(){let n=this.options.minDelay*2**this.attempts,t=Math.random(),e=Math.floor(.5*t*n);return 1===Math.floor(10*t)&&(e=-e),Math.min(n+e,this.options.maxDelay)||0}get connected(){return this.connection.connected}get emitter(){return this.connection.emitter}}class _a{constructor(e={}){if(void 0===e.nodeId)throw new Error("Expected node ID");if("object"!=typeof e.store)throw new Error("Expected store");if(e.nodeId.includes(" "))throw new Error("Space is prohibited in node ID");this.nodeId=e.nodeId,this.lastTime=0,this.sequence=0,this.store=e.store,this.emitter=J()}on(e,t){return this.emitter.on(e,t)}async add(e,t={}){if(void 0===e.type)throw new Error("Expected \"type\" in action");let r=!1;void 0===t.id&&(r=!0,t.id=this.generateId()),void 0===t.time&&(t.time=parseInt(t.id)),void 0===t.reasons?t.reasons=[]:Array.isArray(t.reasons)||(t.reasons=[t.reasons]);for(let s of t.reasons)if("string"!=typeof s)throw new Error("Expected \"reasons\" to be strings");if(this.emitter.emit("preadd",e,t),t.keepLast&&(this.removeReason(t.keepLast,{olderThan:t}),t.reasons.push(t.keepLast)),0===t.reasons.length&&r)return this.emitter.emit("add",e,t),this.emitter.emit("clean",e,t),t;if(0===t.reasons.length){let[r]=await this.store.byId(t.id);return!r&&(this.emitter.emit("add",e,t),this.emitter.emit("clean",e,t),t)}{let r=await this.store.add(e,t);return!1!==r&&(this.emitter.emit("add",e,r),r)}}generateId(){let e=Date.now();return e<=this.lastTime?(e=this.lastTime,this.sequence+=1):(this.lastTime=e,this.sequence=0),e+" "+this.nodeId+" "+this.sequence}each(e,t){t||(t=e,e={order:"created"});let r=this.store;return new Promise(s=>{!async function e(r){let i,n=await r();for(let s=n.entries.length-1;s>=0;s--){let e=n.entries[s];if(!1===(i=t(e[0],e[1])))break}!1!==i&&n.next?e(n.next):s()}(r.get.bind(r,e))})}async changeMeta(e,t){for(let r in t)if("id"===r||"added"===r||"time"===r||"subprotocol"===r)throw new Error("Meta \""+r+"\" is read-only");if(t.reasons&&0===t.reasons.length){let r=await this.store.remove(e);if(r){for(let e in t)r[1][e]=t[e];this.emitter.emit("clean",r[0],r[1])}return!!r}return this.store.changeMeta(e,t)}removeReason(e,t={}){return this.store.removeReason(e,t,(e,t)=>{this.emitter.emit("clean",e,t)})}byId(e){return this.store.byId(e)}}class qc extends _a{constructor(e,t,r={}){r.store||(r.store=new Ta),void 0===r.nodeId&&(r.nodeId="test"+t),super(r),this.time=e}entries(){return this.store.created}actions(){return this.entries().map(e=>e[0])}generateId(){return this.time.lastTime+=1,this.time.lastTime+" "+this.nodeId+" 0"}}class rc{static getLog(t){return new rc().nextLog(t)}constructor(){this.lastId=0,this.lastTime=0}nextLog(t){return this.lastId+=1,new qc(this,this.lastId,t)}}function ab(t){if(Array.isArray(t))return t.map(t=>ab(t));if("object"==typeof t){let i={};for(let s in t)i[s]=ab(t[s]);return i}return t}let oa=(e=21)=>{let t="",o=crypto.getRandomValues(new Uint8Array(e));for(;e--;){let $=63&o[e];t+=$<36?$.toString(36):$<62?($-26).toString(36).toUpperCase():$<63?"_":"-"}return t};var sc={};let tc=["id","time","subprotocol"];function bb(t){localStorage.setItem(t.options.prefix+":tab:"+t.tabId,Date.now())}function cb(t,e){t.log.removeReason("tab"+e).then(()=>{t.isLocalStorage&&localStorage.removeItem(t.options.prefix+":tab:"+e)})}class uc{constructor(t={}){if(this.options=t,void 0===this.options.prefix&&(this.options.prefix="logux"),this.isLocalStorage=!1,"undefined"!=typeof localStorage){let t=oa();try{localStorage.setItem(t,"1"),localStorage.removeItem(t),this.isLocalStorage=!0}catch(c){}}let e;this.options.time?(this.tabId=this.options.time.lastId+1+"",this.clientId=this.options.userId+":"+this.tabId):(this.clientId=this.options.userId+":"+this.getClientId(),this.tabId=oa(8)),this.nodeId=this.clientId+":"+this.tabId,/^ws:\/\//.test(this.options.server)&&!t.allowDangerousProtocol&&(e=async(t,e)=>"development"===e||(console.error("Without SSL, old proxies block WebSockets. Use WSS for Logux or set allowDangerousProtocol option."),!1));let o,i=this.options.store||new Ta;o=this.options.time?this.options.time.nextLog({store:i,nodeId:this.nodeId}):new _a({store:i,nodeId:this.nodeId}),this.log=o,o.on("preadd",(t,e)=>{e.id.includes(" ".concat(this.nodeId," "))&&!e.subprotocol&&(e.subprotocol=this.options.subprotocol),e.sync&&!e.resubscribe&&e.reasons.push("syncing")}),this.last={},this.subscriptions={};let s={},n={};this.emitter=J(),this.on("add",(t,e)=>{let o,i,r=t.type;if("logux/processed"!==r&&"logux/undo"!==r||this.log.removeReason("syncing",{id:t.id}),"logux/subscribe"!==r||e.resubscribe){if("logux/unsubscribe"===r)n[e.id]=t;else if("logux/processed"===r&&n[t.id]){let e=n[t.id];o=JSON.stringify({...e,type:"logux/subscribe"});let i=this.subscriptions[o];i&&(1===i?delete this.subscriptions[o]:this.subscriptions[o]=i-1)}else if("logux/processed"===r&&s[t.id]){let n=s[t.id];delete s[t.id],o=JSON.stringify(n),this.subscriptions[o]?this.subscriptions[o]+=1:this.subscriptions[o]=1,(i=this.last[n.channel])&&!H(i,e)||(this.last[n.channel]={id:e.id,time:e.time})}else"logux/undo"===r?(delete s[t.id],delete n[t.id]):e.channels&&(e.id.includes(" "+this.clientId+":")||e.channels.forEach(t=>{(i=this.last[t])&&!H(i,e)||(this.last[t]={id:e.id,time:e.time})}));}else s[e.id]=t}),this.tabPing=6e4,this.tabTimeout=10*this.tabPing;let r,l="tab"+this.tabId;if(this.isLocalStorage){let t=o.on("add",(e,o)=>{o.reasons.includes(l)&&(bb(this),this.pinging=setInterval(()=>{bb(this)},this.tabPing),t())})}if("string"==typeof this.options.server){let t=new jb(this.options.server);r=new pc(t,{minDelay:this.options.minDelay,maxDelay:this.options.maxDelay,attempts:this.options.attempts})}else r=this.options.server;this.node=new Ya(this.nodeId,this.log,r,{subprotocol:this.options.subprotocol,outFilter:async(t,e)=>!!e.sync&&e.id.includes(" ".concat(this.options.userId,":")),timeout:this.options.timeout,outMap:async(t,e)=>{let o={};for(let i in e)"subprotocol"===i?e.subprotocol!==this.options.subprotocol&&(o.subprotocol=e.subprotocol):tc.includes(i)&&(o[i]=e[i]);return[t,o]},token:this.options.token,ping:this.options.ping,auth:e}),this.node.on("debug",(t,e)=>{"error"===t&&console.error("Error on Logux server:\n",e)});let a=!0;this.node.on("state",()=>{let t=this.node.state;if("synchronized"===t||"sending"===t){if(a){a=!1;for(let t in this.subscriptions){let e=JSON.parse(t),o=this.last[e.channel];o&&(e.since=o),this.log.add(e,{sync:!0,resubscribe:!0})}}}else"disconnected"===this.node.state&&(a=!0)}),this.onUnload=this.onUnload.bind(this),"undefined"!=typeof window&&window.addEventListener&&window.addEventListener("unload",this.onUnload)}start(){this.cleanPrevActions(),this.node.connection.connect()}on(t,e){return this.log.emitter.on(t,e)}changeUser(t,e){let o=this.node.connected;o&&this.node.connection.disconnect("freeze"),this.options.userId=t,this.options.token=e,this.clientId=t+":"+this.clientId.split(":")[1],this.nodeId=this.clientId+":"+this.tabId;let i=this.node.emitter.events;this.node.connection.emitter.events={},this.node=new Ya(this.nodeId,this.log,this.node.connection,{...this.node.options,token:this.options.token}),this.node.emitter.events=i,o&&this.node.connection.connect()}destroy(){this.onUnload(),this.node.destroy(),clearInterval(this.pinging),"undefined"!=typeof window&&window.removeEventListener&&window.removeEventListener("unload",this.onUnload)}clean(){return this.destroy(),this.log.store.clean?this.log.store.clean():Promise.resolve()}cleanPrevActions(){if(this.isLocalStorage)for(let t in localStorage){let e=this.options.prefix+":tab:";if(t.slice(0,e.length)===e){let o=parseInt(localStorage.getItem(t));Date.now()-o>this.tabTimeout&&cb(this,t.slice(e.length))}}}onUnload(){this.pinging&&cb(this,this.tabId)}getClientId(){return oa(8)}}sc={Client:uc};let{Client:vc}=sc;function m(e,t){return e.options.prefix+":"+e.options.userId+":"+t}function X(e,t,r){if(!e.isLocalStorage)return;let a=m(e,t),o=JSON.stringify(r);try{localStorage.setItem(a,o)}catch(i){console.error(i),e.isLocalStorage=!1,e.role="leader",e.emitter.emit("role"),e.node.connection.connect()}}function db(e){let t=localStorage.getItem(m(e,"leader")),r=[];return"string"==typeof t&&(r=JSON.parse(t)),r}function eb(e){X(e,"leader",[e.tabId,Date.now()])}function fb(e){"disconnected"!==e.state&&ib(e,"disconnected"),hb(e)}function Y(e){clearTimeout(e.watching),e.watching=setTimeout(()=>{gb(e)?Y(e):fb(e)},e.roleTimeout)}function wc(e,t){if(!t.subprotocol)return!1;if(e.options.subprotocol===t.subprotocol)return!1;let r=t.id.split(" ")[1],a=e.clientId+":";if(r.slice(0,a.length)!==a)return!1;let o=e.options.subprotocol.split("."),i=t.subprotocol.split(".");for(let s=0;s<o.length;s++){let e=parseInt(o[s]),t=parseInt(i[s]);if(e>t)return!1;if(e<t)return!0}return!1}function I(e,t){if(e.role!==t){let r=e.node;if(e.role=t,clearTimeout(e.watching),"leader"===t?(localStorage.removeItem(m(e,"state")),e.leadership=setInterval(()=>{e.unloading||eb(e)},e.leaderPing),r.connection.connect()):(clearTimeout(e.elections),clearInterval(e.leadership),"disconnected"!==r.state&&e.node.connection.disconnect()),"follower"===t){let t="disconnected",r=localStorage.getItem(m(e,"state"));r&&null!==r&&(t=JSON.parse(r)),t!==e.state&&(e.state=t,e.emitter.emit("state"))}e.emitter.emit("role")}}function gb(e){let t=db(e);return t[1]&&t[1]>=Date.now()-e.leaderTimeout}function hb(e){eb(e),I(e,"candidate"),e.elections=setTimeout(()=>{db(e,"leader")[0]===e.tabId?I(e,"leader"):(I(e,"follower"),Y(e))},e.electionDelay)}function ib(e,t){e.state=t,e.emitter.emit("state"),X(e,"state",e.state)}function xc(e){return e.created&&e.added}class c extends vc{constructor(e={}){super(e),this.role="candidate",this.roleTimeout=3e3+Math.floor(1e3*Math.random()),this.leaderTimeout=5e3,this.leaderPing=2e3,this.electionDelay=1e3,this.state=this.node.state,this.node.on("state",()=>{"leader"===this.role&&ib(this,this.node.state)}),this.log.on("add",(e,t)=>{this.emitter.emit("add",e,t),t.tab!==this.tabId&&X(this,"add",[this.tabId,e,t])}),this.log.on("clean",(e,t)=>{this.emitter.emit("clean",e,t)}),"undefined"!=typeof window&&window.addEventListener&&(window.addEventListener("storage",e=>this.onStorage(e)),window.addEventListener("unload",e=>this.onUnload(e)))}start(){if(this.cleanPrevActions(),!this.isLocalStorage)return this.role="leader",this.emitter.emit("role"),void this.node.connection.connect();gb(this)?(I(this,"follower"),Y(this)):hb(this)}destroy(){super.destroy(),clearTimeout(this.watching),clearTimeout(this.elections),clearInterval(this.leadership),"undefined"!=typeof window&&window.removeEventListener&&window.removeEventListener("storage",this.onStorage)}clean(){return this.isLocalStorage&&(localStorage.removeItem(m(this,"add")),localStorage.removeItem(m(this,"state")),localStorage.removeItem(m(this,"client")),localStorage.removeItem(m(this,"leader"))),super.clean()}on(e,t){return"preadd"===e?this.log.emitter.on(e,t):this.emitter.on(e,t)}onStorage(e){if(null===e.newValue)return;let t;if(e.key===m(this,"add")){if((t=JSON.parse(e.newValue))[0]!==this.tabId){let e=t[1],r=t[2];if(wc(this,r)){let e=new z("wrong-subprotocol",{supported:r.subprotocol,used:this.node.options.subprotocol},!0);this.node.emitter.emit("error",e)}r.tab&&r.tab!==this.tabId||(xc(this.log.store)&&this.log.store.add(e,r),this.emitter.emit("add",e,r),"leader"===this.role&&this.node.onAdd(e,r))}}else if(e.key===m(this,"leader"))0===(t=JSON.parse(e.newValue)).length?fb(this):t[0]!==this.tabId&&"candidate"!==this.role&&(I(this,"follower"),Y(this));else if(e.key===m(this,"state")){let t=JSON.parse(localStorage.getItem(e.key));this.state!==t&&(this.state=t,this.emitter.emit("state"))}}onUnload(){"leader"===this.role&&(this.unloading=!0,X(this,"leader",[])),super.onUnload()}getClientId(){let e=m(this,"client");if(this.isLocalStorage){if(localStorage.getItem(e))return localStorage.getItem(e);{let t=super.getClientId();return localStorage.setItem(e,t),t}}return super.getClientId()}get connected(){return"disconnected"!==this.state&&"connecting"!==this.state}}var yc={};function zc(e,t,o={}){let r,n=e.on?e:e.node,s="disconnected"===n.state,d=!1,i=!1;void 0===o.duration&&(o.duration=3e3);let c=[],a={},u=()=>{0===Object.keys(a).length&&(d?(d=!1,t("synchronizedAfterWait"),r=setTimeout(()=>{t("synchronized")},o.duration)):t("synchronized"))};c.push(n.on("state",()=>{clearTimeout(r),i||("disconnected"===n.state?(s=!0,t(d?"wait":"disconnected")):"synchronized"===n.state?(s=!1,u()):"connecting"===n.state?r=setTimeout(()=>{t("connecting"+(d?"AfterWait":""))},100):t(e.state+(d?"AfterWait":"")))})),c.push(e.node.on("error",e=>{"wrong-protocol"===e.type||"wrong-subprotocol"===e.type?(i=!0,t("protocolError")):"timeout"!==e.type&&t("syncError",{error:e})})),c.push(e.node.on("clientError",e=>{t("syncError",{error:e})}));let l=e.on?e:e.log;return c.push(l.on("add",(e,o)=>{"logux/subscribe"!==e.type&&"logux/unsubscribe"!==e.type&&("logux/processed"===e.type?(delete a[e.id],u()):"logux/undo"===e.type?delete a[e.id]:o.sync&&(a[o.id]=!0),"logux/undo"===e.type&&e.reason?"denied"===e.reason?t("denied",{action:e,meta:o}):t("error",{action:e,meta:o}):s&&o.sync&&o.added&&(d||t("wait"),d=!0))})),()=>{for(let e of c)e()}}yc={status:zc};let{status:d}=yc;})();